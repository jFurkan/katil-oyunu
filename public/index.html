<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Katil Kim? - Y√∂netici Paneli</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505;
            --card-bg: #111111;
            --border-color: #222;
            --accent: #8B0000; /* Kan Kƒ±rmƒ±zƒ±sƒ± */
            --gold: #D4AF37;
            --text-main: #e0e0e0;
            --text-muted: #888;
            --success: #2d5a27;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-main); min-height: 100vh; font-size: 14px; }
        
        /* Genel Yapƒ± */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Header & Ba≈ülƒ±klar */
        header { text-align: center; padding: 40px 0; }
        h1 { font-size: 42px; letter-spacing: -1px; margin-bottom: 10px; }
        h1 span { color: var(--accent); }
        .subtitle { color: var(--text-muted); font-style: italic; }

        /* Sayfa Ge√ßi≈üleri */
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Butonlar (Global) */
        .btn { width: 100%; padding: 16px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-main); font-size: 15px; cursor: pointer; margin-bottom: 12px; transition: all 0.2s; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:hover { border-color: var(--accent); background: #1a1a1a; transform: translateY(-2px); }
        .btn-primary { background: var(--accent); border-color: var(--accent); color: white; }
        .btn-primary:hover { background: #a00000; }
        
        /* Form Alanlarƒ± */
        .form-box { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-top: 20px; max-width: 400px; margin-left: auto; margin-right: auto; }
        input { width: 100%; padding: 14px; background: #000; border: 1px solid var(--border-color); border-radius: 6px; color: white; font-size: 16px; margin-bottom: 15px; outline: none; transition: border 0.2s; }
        input:focus { border-color: var(--gold); }

        /* --- YENƒ∞LENEN ADMIN PANEL TASARIMI --- */
        
        /* Admin Header */
        .admin-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .back-btn { padding: 8px 16px; background: #222; border: none; border-radius: 6px; color: #fff; cursor: pointer; font-size: 13px; }
        .back-btn:hover { background: #333; }

        /* Admin Grid - YANYANA KUTULAR ƒ∞√áƒ∞N KRƒ∞Tƒ∞K KISIM */
        .admin-list { 
            display: grid; 
            /* En az 320px geni≈üliƒüinde, ekrana sƒ±ƒüdƒ±ƒüƒ± kadar yan yana dizersin */
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); 
            gap: 20px; 
            margin-bottom: 40px;
        }

        /* Admin Kartƒ± (Yenilenmi≈ü UX) */
        .admin-card { 
            background: var(--card-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 12px; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .admin-card:hover { border-color: #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: translateY(-3px); }

        /* Kart √úst Kƒ±sƒ±m */
        .card-header { 
            padding: 15px; 
            background: linear-gradient(to bottom, #1a1a1a, #111); 
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .team-identity { display: flex; align-items: center; gap: 10px; }
        .rank-badge { 
            width: 28px; height: 28px; border-radius: 50%; 
            background: #222; color: #888; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; font-size: 12px;
        }
        .rank-badge.g { background: var(--gold); color: black; box-shadow: 0 0 10px rgba(212, 175, 55, 0.3); }
        .rank-badge.s { background: #C0C0C0; color: black; }
        .rank-badge.b { background: #cd7f32; color: black; }
        
        .team-name { font-weight: 600; font-size: 16px; color: #fff; }
        .team-score { font-size: 24px; font-weight: 700; color: var(--gold); letter-spacing: -1px; }

        /* Kart ƒ∞√ßerik */
        .card-body { padding: 15px; flex: 1; display: flex; flex-direction: column; gap: 15px; }

        /* ƒ∞pu√ßlarƒ± Alanƒ± */
        .clues-section { flex: 1; min-height: 100px; max-height: 150px; overflow-y: auto; background: #080808; border-radius: 6px; padding: 8px; border: 1px solid #222; }
        .clues-title { font-size: 11px; text-transform: uppercase; color: #666; margin-bottom: 6px; letter-spacing: 1px; font-weight: 600; }
        .clue-item { font-size: 13px; padding: 6px 8px; border-left: 2px solid var(--gold); background: #111; margin-bottom: 4px; border-radius: 0 4px 4px 0; color: #ccc; }
        .clue-time { float: right; font-size: 10px; color: #555; margin-top: 2px; }
        .no-clues { color: #444; font-style: italic; text-align: center; padding-top: 30px; font-size: 12px; }

        /* Kontrol Butonlarƒ± (Grid Layout) */
        .controls-section { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; }
        .ctrl-btn { 
            padding: 8px 0; border: none; border-radius: 4px; 
            font-weight: bold; font-size: 13px; cursor: pointer; color: white; transition: opacity 0.2s;
        }
        .ctrl-btn:hover { opacity: 0.8; }
        .btn-p10 { background: #2d5a27; }
        .btn-p5 { background: #3d6b36; }
        .btn-m5 { background: #964B00; }
        .btn-m10 { background: var(--accent); }
        
        .delete-btn { 
            margin-top: 10px; width: 100%; background: transparent; border: 1px dashed #444; color: #666; 
            padding: 8px; font-size: 11px; border-radius: 4px; cursor: pointer; 
        }
        .delete-btn:hover { border-color: var(--accent); color: var(--accent); }

        /* ƒ∞statistikler Grafiƒüi */
        .stats-chart { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 25px; }
        .chart-bar { display: flex; align-items: center; gap: 15px; margin-bottom: 12px; }
        .chart-label { width: 100px; font-size: 13px; text-align: right; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #aaa; }
        .chart-track { flex: 1; height: 12px; background: #222; border-radius: 6px; overflow: hidden; }
        .chart-fill { height: 100%; background: linear-gradient(90deg, #c9a227, #f0e6d3); border-radius: 6px; width: 0%; transition: width 0.5s cubic-bezier(0.1, 0.7, 1.0, 0.1); }
        .chart-val { width: 30px; font-weight: bold; color: var(--gold); font-size: 13px; }

        /* Diƒüer Sayfalar i√ßin Ufak D√ºzeltmeler */
        .team-list { display: flex; flex-direction: column; gap: 8px; }
        .team-opt { padding: 15px; background: #161616; border: 1px solid #333; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .team-opt:hover, .team-opt.sel { border-color: var(--accent); background: #1f1f1f; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal.show { display: flex; }
        .modal-box { background: #111; border: 1px solid #333; padding: 30px; border-radius: 16px; width: 90%; max-width: 350px; text-align: center; }

        #toast { position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 50px); background: #333; color: #fff; padding: 12px 24px; border-radius: 50px; opacity: 0; transition: 0.3s; z-index: 9999; box-shadow: 0 5px 20px rgba(0,0,0,0.5); font-weight: 500; }
        #toast.show { transform: translate(-50%, 0); opacity: 1; }
        #toast.err { background: var(--accent); }

        /* Bildirim Sistemi */
        .notification-popup { position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #1a1a1a, #111); border: 1px solid var(--gold); border-radius: 12px; padding: 20px; min-width: 320px; max-width: 400px; box-shadow: 0 10px 40px rgba(212,175,55,0.3); z-index: 10000; transform: translateX(500px); opacity: 0; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .notification-popup.show { transform: translateX(0); opacity: 1; }
        .notif-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .notif-title { font-size: 14px; font-weight: 600; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; }
        .notif-close { background: transparent; border: none; color: #666; font-size: 20px; cursor: pointer; padding: 0; width: 24px; height: 24px; }
        .notif-close:hover { color: #fff; }
        .notif-body { color: #ccc; font-size: 14px; line-height: 1.6; }
        .notif-time { font-size: 11px; color: #555; margin-top: 10px; text-align: right; }
        .notif-badge { position: fixed; top: 20px; right: 30px; background: var(--accent); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; z-index: 9998; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        /* Bildirimler Sayfasƒ± */
        .notif-list { display: flex; flex-direction: column; gap: 12px; }
        .notif-item { background: var(--card-bg); border: 1px solid var(--border-color); border-left: 4px solid var(--gold); border-radius: 8px; padding: 15px; transition: 0.2s; }
        .notif-item:hover { border-color: var(--gold); background: #161616; }
        .notif-item.unread { background: rgba(212,175,55,0.05); }
        .notif-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .notif-item-title { font-weight: 600; color: var(--gold); font-size: 13px; }
        .notif-item-time { font-size: 11px; color: #666; }
        .notif-item-body { color: #aaa; font-size: 13px; line-height: 1.5; }

        /* Duyuru Formu */
        .announcement-form { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .announcement-form textarea { width: 100%; min-height: 80px; background: #000; border: 1px solid var(--border-color); border-radius: 6px; color: white; padding: 12px; font-family: inherit; resize: vertical; margin-bottom: 10px; }
        .announcement-form textarea:focus { outline: none; border-color: var(--gold); }
    </style>
</head>
<body>
    <div class="container">
        <div class="page active" id="pgLobby">
            <header>
                <h1>Katil <span>Kim?</span></h1>
                <p class="subtitle">"≈û√ºphe, ger√ßeƒüin g√∂lgesidir..."</p>
            </header>
            <div style="max-width: 400px; margin: 0 auto;">
                <button class="btn" onclick="GAME.showCreateForm()">üé≠ Yeni Takƒ±m Olu≈ütur</button>
                <button class="btn" onclick="GAME.showJoinForm()">üîë Takƒ±ma Giri≈ü Yap</button>
                <button class="btn" onclick="GAME.showScoreboard()">üèÜ Skor Tablosu</button>
                <button class="btn" onclick="GAME.showNotifications()">
                    üîî Bildirimler
                    <span id="notifBadgeLobby" style="display:none; background:var(--accent); color:white; border-radius:50%; width:20px; height:20px; font-size:11px; margin-left:auto;"></span>
                </button>
                <button class="btn" style="margin-top: 30px; color: #666; border-color: transparent;" onclick="GAME.showPassModal()">üîí Y√∂netici Paneli</button>
            </div>

            <div class="form-box" id="createForm" style="display:none;">
                <h3 style="margin-bottom:15px; color:white;">Yeni Takƒ±m</h3>
                <input type="text" id="inpNewTeam" placeholder="Takƒ±m adƒ±..." maxlength="20">
                <div style="display:flex; gap:10px;">
                    <button class="btn" onclick="GAME.hideCreateForm()">ƒ∞ptal</button>
                    <button class="btn btn-primary" onclick="GAME.createTeam()">Olu≈ütur</button>
                </div>
            </div>

            <div class="form-box" id="joinForm" style="display:none;">
                <h3 style="margin-bottom:15px; color:white;">Takƒ±m Se√ß</h3>
                <div class="team-list" id="joinList" style="max-height:200px; overflow-y:auto; margin-bottom:15px;"></div>
                <div style="display:flex; gap:10px;">
                    <button class="btn" onclick="GAME.hideJoinForm()">ƒ∞ptal</button>
                    <button class="btn btn-primary" onclick="GAME.joinTeam()">Giri≈ü</button>
                </div>
            </div>
        </div>

        <div class="page" id="pgTeam">
            <header style="padding: 20px 0;">
                <div style="color:#666; font-size:12px; letter-spacing: 2px; text-transform: uppercase;">Dedektif Paneli</div>
                <h1 id="dispTeamName" style="font-size:32px; margin-top:5px;">-</h1>
            </header>
            
            <div style="max-width:500px; margin: 0 auto;">
                <div style="background:#111; padding:20px; border-radius:12px; border:1px solid #222; margin-bottom:20px;">
                    <h3 style="margin-bottom:12px; color:var(--gold);">üîé Yeni ƒ∞pucu</h3>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="inpClue" placeholder="Bulduƒüunuz ipucunu yazƒ±n..." style="margin:0;">
                        <button class="btn btn-primary" style="width:auto; margin:0;" onclick="GAME.addClue()">G√∂nder</button>
                    </div>
                </div>

                <div style="background:#111; padding:20px; border-radius:12px; border:1px solid #222;">
                    <h3 style="margin-bottom:12px; display:flex; justify-content:space-between;">
                        üìã Kayƒ±tlar <span id="clueCnt" style="color:#666; font-size:14px;">(0)</span>
                    </h3>
                    <div id="myClueList" style="max-height:300px; overflow-y:auto;"></div>
                </div>
                <button class="btn" style="margin-top:20px; border-color:#333;" onclick="GAME.exitTeam()">üö™ √áƒ±kƒ±≈ü Yap</button>
            </div>
        </div>

        <div class="page" id="pgAdmin">
            <div class="admin-head">
                <div>
                    <h2 style="font-size:24px;">üëÅÔ∏è Y√∂netici Paneli</h2>
                    <div style="color:#666; font-size:12px; margin-top:4px;">
                        <span id="statTeams">0</span> Takƒ±m ‚Ä¢ <span id="statClues">0</span> ƒ∞pucu
                    </div>
                </div>
                <button class="back-btn" onclick="GAME.goLobby()">√áƒ±kƒ±≈ü</button>
            </div>
            
            <div class="announcement-form">
                <h3 style="color:var(--gold); font-size:14px; margin-bottom:12px;">üì¢ Genel Duyuru G√∂nder</h3>
                <textarea id="announcementText" placeholder="T√ºm takƒ±mlara g√∂nderilecek duyuruyu yazƒ±n..."></textarea>
                <button class="btn btn-primary" style="width:auto; padding:10px 24px; margin:0;" onclick="ADMIN.sendAnnouncement()">Duyuruyu G√∂nder</button>
            </div>

            <div class="stats-chart" id="statsChart">
                <h3 style="color:#666; font-size:12px; text-transform:uppercase; margin-bottom:15px;">üìä Canlƒ± Puan Durumu</h3>
                <div id="chartContent"></div>
            </div>

            <div id="adminList" class="admin-list"></div>

            <button class="btn" style="background:#300; color:#faa; border:1px solid #500; margin-top:30px;" onclick="GAME.resetGame()">‚ö†Ô∏è OYUNU SIFIRLA (T√ºm Takƒ±mlarƒ± Sil)</button>
        </div>

        <div class="page" id="pgScoreboard">
            <div class="admin-head">
                <h2>üèÜ Liderlik Tablosu</h2>
                <button class="back-btn" onclick="GAME.goLobby()">Geri</button>
            </div>
            <div id="scoreboardList" style="max-width:600px; margin:0 auto;"></div>
        </div>

        <div class="page" id="pgNotifications">
            <div class="admin-head">
                <h2>üîî Bildirimler</h2>
                <button class="back-btn" onclick="GAME.goLobby()">Geri</button>
            </div>
            <div style="max-width:700px; margin:0 auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <div style="color:#888; font-size:13px;">
                        Toplam <span id="notifCount">0</span> bildirim
                    </div>
                    <button class="btn" style="width:auto; padding:8px 16px; font-size:12px; margin:0;" onclick="NOTIF.markAllRead()">T√ºm√ºn√º Okundu ƒ∞≈üaretle</button>
                </div>
                <div class="notif-list" id="notifList"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="passModal">
        <div class="modal-box">
            <h3 style="margin-bottom:10px; color:white;">Y√∂netici Giri≈üi</h3>
            <input type="password" id="inpPass" maxlength="6" placeholder="******" style="text-align:center; letter-spacing:5px; font-size:20px;">
            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="GAME.hidePassModal()">ƒ∞ptal</button>
                <button class="btn btn-primary" onclick="GAME.checkPass()">Giri≈ü</button>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <!-- Bildirim Popup -->
    <div id="notificationPopup" class="notification-popup">
        <div class="notif-header">
            <div class="notif-title" id="popupTitle">Bildirim</div>
            <button class="notif-close" onclick="NOTIF.closePopup()">√ó</button>
        </div>
        <div class="notif-body" id="popupBody"></div>
        <div class="notif-time" id="popupTime"></div>
    </div>

    <!-- Bildirim Sesi -->
    <audio id="notificationSound" preload="auto">
        <source src="/notification.mp3" type="audio/mpeg">
        <source src="/notification.ogg" type="audio/ogg">
        <source src="/notification.wav" type="audio/wav">
    </audio>

    <script>
        (function() {
            var socket = io();
            var teams = [];
            var currentTeamId = localStorage.getItem('currentTeamId');
            var selectedJoinId = null;
            var isProcessing = false;
            var notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            var popupTimeout = null;

            // UI Yardƒ±mcƒ±larƒ±
            function toast(msg, err) {
                var t = document.getElementById('toast');
                t.textContent = msg;
                t.className = err ? 'show err' : 'show';
                setTimeout(function() { t.className = ''; }, 2500);
            }

            function showPage(id) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            }

            // Global Fonksiyonlar (HTML onclick i√ßin)
            window.adminScore = function(teamId, amount) {
                if (isProcessing) return;
                isProcessing = true;
                socket.emit('change-score', { teamId: teamId, amount: amount }, function(res) {
                    isProcessing = false;
                    if (!res.success) toast(res.error, true);
                });
            };

            window.adminDel = function(teamId, teamName) {
                if (isProcessing) return;
                if (confirm(teamName + ' takƒ±mƒ±nƒ± silmek istiyor musunuz?')) {
                    isProcessing = true;
                    socket.emit('delete-team', teamId, function(res) {
                        isProcessing = false;
                        if (res.success) toast('Takƒ±m silindi.');
                        else toast(res.error, true);
                    });
                }
            };

            window.GAME = {
                showCreateForm: function() { 
                    document.getElementById('createForm').style.display = 'block'; 
                    document.getElementById('joinForm').style.display = 'none';
                    document.getElementById('inpNewTeam').focus();
                },
                hideCreateForm: function() { document.getElementById('createForm').style.display = 'none'; },
                showJoinForm: function() {
                    document.getElementById('joinForm').style.display = 'block';
                    document.getElementById('createForm').style.display = 'none';
                    renderJoinList();
                },
                hideJoinForm: function() { document.getElementById('joinForm').style.display = 'none'; },
                
                createTeam: function() {
                    var name = document.getElementById('inpNewTeam').value.trim();
                    if (!name) { toast('ƒ∞sim giriniz', true); return; }
                    socket.emit('create-team', name, function(res) {
                        if (res.success) {
                            currentTeamId = res.team.id;
                            localStorage.setItem('currentTeamId', currentTeamId);
                            GAME.hideCreateForm();
                            document.getElementById('inpNewTeam').value = '';
                            showPage('pgTeam');
                            renderTeamPage(res.team);
                        } else { toast(res.error, true); }
                    });
                },
                selectJoin: function(el) {
                    selectedJoinId = el.getAttribute('data-id');
                    document.querySelectorAll('.team-opt').forEach(d => d.classList.remove('sel'));
                    el.classList.add('sel');
                },
                joinTeam: function() {
                    if (!selectedJoinId) { toast('Takƒ±m se√ßiniz', true); return; }
                    socket.emit('join-team', selectedJoinId, function(res) {
                        if (res.success) {
                            currentTeamId = selectedJoinId;
                            localStorage.setItem('currentTeamId', currentTeamId);
                            GAME.hideJoinForm();
                            showPage('pgTeam');
                            renderTeamPage(res.team);
                        } else { toast(res.error, true); }
                    });
                },
                addClue: function() {
                    var inp = document.getElementById('inpClue');
                    var txt = inp.value.trim();
                    if (!txt) { toast('Bo≈ü ipucu g√∂nderilemez', true); return; }
                    socket.emit('add-clue', { teamId: currentTeamId, clue: txt }, function(res) {
                        if (res.success) { inp.value = ''; toast('ƒ∞pucu iletildi'); }
                        else { toast(res.error, true); }
                    });
                },
                exitTeam: function() {
                    currentTeamId = null;
                    localStorage.removeItem('currentTeamId');
                    showPage('pgLobby');
                },
                showPassModal: function() { 
                    document.getElementById('passModal').classList.add('show'); 
                    document.getElementById('inpPass').value = '';
                    document.getElementById('inpPass').focus();
                },
                hidePassModal: function() { document.getElementById('passModal').classList.remove('show'); },
                checkPass: function() {
                    var pass = document.getElementById('inpPass').value;
                    socket.emit('admin-login', pass, function(res) {
                        if (res.success) {
                            GAME.hidePassModal();
                            showPage('pgAdmin');
                            renderAdminList();
                        } else { toast('Hatalƒ± ≈üifre', true); }
                    });
                },
                goLobby: function() { showPage('pgLobby'); },
                showScoreboard: function() { showPage('pgScoreboard'); renderScoreboard(); },
                showNotifications: function() { showPage('pgNotifications'); NOTIF.render(); },
                resetGame: function() {
                    if (confirm('T√úM veriler silinecek. Emin misiniz?')) {
                        socket.emit('reset-game', function(res) { toast('Oyun sƒ±fƒ±rlandƒ±'); });
                    }
                }
            };

            // Bƒ∞LDƒ∞Rƒ∞M Sƒ∞STEMƒ∞
            window.NOTIF = {
                add: function(title, message, type) {
                    var notif = {
                        id: Date.now() + Math.random(),
                        title: title,
                        message: message,
                        type: type || 'info', // 'score', 'announcement', 'info'
                        time: new Date().toLocaleString('tr-TR'),
                        unread: true
                    };
                    notifications.unshift(notif);
                    if (notifications.length > 50) notifications = notifications.slice(0, 50); // Max 50 bildirim
                    localStorage.setItem('notifications', JSON.stringify(notifications));
                    this.updateBadge();
                    this.showPopup(notif);
                },

                showPopup: function(notif) {
                    document.getElementById('popupTitle').textContent = notif.title;
                    document.getElementById('popupBody').textContent = notif.message;
                    document.getElementById('popupTime').textContent = notif.time;

                    var popup = document.getElementById('notificationPopup');
                    popup.classList.add('show');

                    // Bildirim sesini √ßal
                    this.playSound();

                    if (popupTimeout) clearTimeout(popupTimeout);
                    popupTimeout = setTimeout(function() {
                        popup.classList.remove('show');
                    }, 6000);
                },

                playSound: function() {
                    var audio = document.getElementById('notificationSound');
                    if (audio) {
                        audio.currentTime = 0; // Ba≈üa sar
                        audio.volume = 0.5; // Ses seviyesi %50
                        audio.play().catch(function(err) {
                            console.log('Ses √ßalƒ±namadƒ±:', err);
                        });
                    }
                },

                closePopup: function() {
                    document.getElementById('notificationPopup').classList.remove('show');
                    if (popupTimeout) clearTimeout(popupTimeout);
                },

                updateBadge: function() {
                    var unreadCount = notifications.filter(n => n.unread).length;
                    var badge = document.getElementById('notifBadgeLobby');
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                },

                markAllRead: function() {
                    notifications.forEach(n => n.unread = false);
                    localStorage.setItem('notifications', JSON.stringify(notifications));
                    this.updateBadge();
                    this.render();
                },

                render: function() {
                    var container = document.getElementById('notifList');
                    document.getElementById('notifCount').textContent = notifications.length;

                    if (notifications.length === 0) {
                        container.innerHTML = '<div style="text-align:center; padding:60px; color:#666;">Hen√ºz bildirim yok</div>';
                        return;
                    }

                    // Bildirimleri okundu i≈üaretle (sayfa a√ßƒ±ldƒ±ƒüƒ±nda)
                    notifications.forEach(n => n.unread = false);
                    localStorage.setItem('notifications', JSON.stringify(notifications));
                    this.updateBadge();

                    var html = '';
                    notifications.forEach(n => {
                        var icon = 'üì¢';
                        if (n.type === 'score') icon = 'üéØ';
                        else if (n.type === 'announcement') icon = 'üì¢';

                        html += `
                        <div class="notif-item ${n.unread ? 'unread' : ''}">
                            <div class="notif-item-header">
                                <div class="notif-item-title">${icon} ${n.title}</div>
                                <div class="notif-item-time">${n.time}</div>
                            </div>
                            <div class="notif-item-body">${n.message}</div>
                        </div>`;
                    });
                    container.innerHTML = html;
                }
            };

            // Y√ñNETƒ∞Cƒ∞ FONKSƒ∞YONLARI
            window.ADMIN = {
                sendAnnouncement: function() {
                    var text = document.getElementById('announcementText').value.trim();
                    if (!text) {
                        toast('Duyuru metni giriniz', true);
                        return;
                    }
                    if (confirm('Bu duyuru t√ºm takƒ±mlara g√∂nderilecek. Emin misiniz?')) {
                        socket.emit('send-announcement', text, function(res) {
                            if (res.success) {
                                document.getElementById('announcementText').value = '';
                                toast('Duyuru g√∂nderildi');
                            } else {
                                toast(res.error, true);
                            }
                        });
                    }
                }
            };

            // RENDER FONKSƒ∞YONLARI

            function renderJoinList() {
                var c = document.getElementById('joinList');
                if (teams.length === 0) { c.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">Aktif takƒ±m yok</div>'; return; }
                var html = '';
                teams.forEach(t => {
                    html += `<div class="team-opt" data-id="${t.id}" onclick="GAME.selectJoin(this)">
                        <div style="font-weight:bold;color:#fff;">${t.name}</div>
                        <div style="font-size:12px;color:#666;">Puan: ${t.score}</div>
                    </div>`;
                });
                c.innerHTML = html;
            }

            function renderTeamPage(team) {
                document.getElementById('dispTeamName').textContent = team.name;
                document.getElementById('clueCnt').textContent = '(' + team.clues.length + ')';
                var list = document.getElementById('myClueList');
                if (team.clues.length === 0) {
                    list.innerHTML = '<div style="color:#444;text-align:center;padding:20px;">Hen√ºz ipucu girilmedi.</div>';
                } else {
                    var html = '';
                    // Tersten sƒ±rala (en yeni en √ºstte)
                    for (var i = team.clues.length - 1; i >= 0; i--) {
                        html += `<div style="padding:10px; border-bottom:1px solid #222; color:#ccc;">${team.clues[i].text}</div>`;
                    }
                    list.innerHTML = html;
                }
            }

            // --- YENƒ∞LENMƒ∞≈û ADMIN KART RENDER ---
            function renderAdminList() {
                // ƒ∞statistikleri g√ºncelle
                document.getElementById('statTeams').textContent = teams.length;
                var totalClues = teams.reduce((acc, t) => acc + t.clues.length, 0);
                document.getElementById('statClues').textContent = totalClues;

                var container = document.getElementById('adminList');
                if (teams.length === 0) {
                    container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#444;">Hen√ºz takƒ±m yok.</div>';
                    document.getElementById('chartContent').innerHTML = '';
                    return;
                }

                // Sƒ±ralama
                var sorted = teams.slice().sort((a, b) => b.score - a.score);
                renderScoreChart(sorted);

                var html = '';
                sorted.forEach((t, index) => {
                    var safeName = t.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
                    var rankClass = '';
                    if (index === 0 && t.score > 0) rankClass = 'g';
                    else if (index === 1 && t.score > 0) rankClass = 's';
                    else if (index === 2 && t.score > 0) rankClass = 'b';

                    // Kart HTML Yapƒ±sƒ±
                    html += `
                    <div class="admin-card" id="card_${t.id}">
                        <div class="card-header">
                            <div class="team-identity">
                                <div class="rank-badge ${rankClass}">${index + 1}</div>
                                <div class="team-name">${t.name}</div>
                            </div>
                            <div class="team-score" id="score_${t.id}">${t.score}</div>
                        </div>
                        <div class="card-body">
                            <div class="controls-section">
                                <button class="ctrl-btn btn-p10" onclick="adminScore('${t.id}', 10)">+10</button>
                                <button class="ctrl-btn btn-p5" onclick="adminScore('${t.id}', 5)">+5</button>
                                <button class="ctrl-btn btn-m5" onclick="adminScore('${t.id}', -5)">-5</button>
                                <button class="ctrl-btn btn-m10" onclick="adminScore('${t.id}', -10)">-10</button>
                            </div>
                            
                            <div class="clues-section" id="clues_${t.id}">
                                <div class="clues-title">ƒ∞PU√áLARI (${t.clues.length})</div>
                                ${ t.clues.length === 0 
                                    ? '<div class="no-clues">ƒ∞pucu yok</div>' 
                                    : t.clues.map(c => 
                                        `<div class="clue-item">${c.text}<div class="clue-time">${c.time}</div><div style="clear:both"></div></div>`
                                      ).join('') 
                                }
                            </div>
                            
                            <button class="delete-btn" onclick="adminDel('${t.id}', '${safeName}')">Takƒ±mƒ± Sil</button>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            }

            function renderScoreChart(sortedTeams) {
                var maxScore = Math.max(...sortedTeams.map(t => t.score));
                if (maxScore <= 0) maxScore = 1;
                
                var html = '';
                sortedTeams.forEach(t => {
                    var pct = Math.max(0, (t.score / maxScore) * 100);
                    html += `
                    <div class="chart-bar">
                        <div class="chart-label">${t.name}</div>
                        <div class="chart-track">
                            <div class="chart-fill" style="width: ${pct}%"></div>
                        </div>
                        <div class="chart-val">${t.score}</div>
                    </div>`;
                });
                document.getElementById('chartContent').innerHTML = html;
            }

            function renderScoreboard() {
                var c = document.getElementById('scoreboardList');
                if (teams.length === 0) { c.innerHTML = '<div style="text-align:center; color:#666; padding:40px;">Veri yok</div>'; return; }
                
                var sorted = teams.slice().sort((a, b) => b.score - a.score);
                var html = '';
                sorted.forEach((t, i) => {
                    var bg = '#161616';
                    var border = '#333';
                    var color = '#fff';
                    if (i===0) { border = '#D4AF37'; color='#D4AF37'; }
                    
                    html += `
                    <div style="background:${bg}; border:1px solid ${border}; padding:20px; border-radius:10px; margin-bottom:10px; display:flex; align-items:center; justify-content:space-between;">
                        <div style="display:flex; align-items:center; gap:15px;">
                            <div style="font-size:20px; font-weight:bold; width:30px; text-align:center; color:#666;">${i+1}</div>
                            <div style="font-size:18px; font-weight:600; color:#fff;">${t.name}</div>
                        </div>
                        <div style="font-size:24px; font-weight:bold; color:${color};">${t.score}</div>
                    </div>`;
                });
                c.innerHTML = html;
            }

            // Sadece skor deƒüi≈ütiƒüinde (performans i√ßin)
            function updateScoresOnly() {
                // Grafiƒüi yeniden √ßiz
                var sorted = teams.slice().sort((a, b) => b.score - a.score);
                renderScoreChart(sorted);

                // Kartlardaki sayƒ±larƒ± g√ºncelle
                teams.forEach(t => {
                    var el = document.getElementById('score_' + t.id);
                    if (el) el.textContent = t.score;
                });
            }

            // Socket Listeners
            socket.on('teams-update', function(newTeams) {
                var oldLen = teams.length;
                teams = newTeams;
                
                if (document.getElementById('pgAdmin').classList.contains('active')) {
                    // Takƒ±m sayƒ±sƒ± deƒüi≈ütiyse full render, deƒüi≈ümediyse sadece skor g√ºncelle (titremeyi √∂nlemek i√ßin)
                    if (oldLen !== teams.length) renderAdminList();
                    else {
                        // ƒ∞pucu sayƒ±sƒ± deƒüi≈ümi≈ü mi kontrol et
                        // Basitlik i√ßin full render yapabiliriz ama UX i√ßin ayrƒ±≈ütƒ±rmak iyidir.
                        // ≈ûimdilik temiz olmasƒ± i√ßin full render yapalƒ±m, grid yapƒ±sƒ± stabil zaten.
                        renderAdminList(); 
                    }
                }
                
                if (document.getElementById('pgScoreboard').classList.contains('active')) renderScoreboard();
                if (document.getElementById('joinForm').style.display === 'block') renderJoinList();
                
                if (currentTeamId) {
                    var myTeam = teams.find(t => t.id === currentTeamId);
                    if (myTeam) renderTeamPage(myTeam);
                }
            });

            socket.on('team-deleted', function(id) {
                if (currentTeamId === id) {
                    currentTeamId = null;
                    localStorage.removeItem('currentTeamId');
                    showPage('pgLobby');
                    toast('Takƒ±m silindi', true);
                }
            });

            socket.on('game-reset', function() {
                currentTeamId = null;
                localStorage.removeItem('currentTeamId');
                showPage('pgLobby');
            });

            // Bildirim Eventi
            socket.on('notification', function(data) {
                NOTIF.add(data.title, data.message, data.type);
            });

            // Puan deƒüi≈üikliƒüi bildirimi
            socket.on('score-changed', function(data) {
                var msg = data.teamName + ' takƒ±mƒ± ' + (data.amount > 0 ? '+' : '') + data.amount + ' puan aldƒ±. Yeni puan: ' + data.newScore;
                NOTIF.add('Puan Deƒüi≈üikliƒüi', msg, 'score');
            });

            // Init
            window.onload = function() {
                NOTIF.updateBadge(); // Bildirim badge'ini g√ºncelle

                if (currentTeamId) {
                    socket.emit('get-team', currentTeamId, function(t) {
                        if (t) { showPage('pgTeam'); renderTeamPage(t); }
                        else { currentTeamId = null; localStorage.removeItem('currentTeamId'); }
                    });
                }
            };
        })();
    </script>
</body>
</html>